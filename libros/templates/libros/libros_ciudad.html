{% extends 'base.html' %}
{% load staticfiles %}

{% block content %}

<!-- PAGE TOP -->
<!-- parallax -->
<div class="parallax parallax-1" style="background-image:url({% static 'assets/images/letrasclub/quito2.jpg' %});">
	<span class="parallax-overlay"></span>
	<div class="container parallax-content">
		<div class="row">
			<div class="col-md-5 col-sm-5 col-md-offset-1">
				<h3> Libros disponibles en <strong>{{ciudad.name}}</strong></h3>
			</div>
		</div>
	</div>
</div>
<!-- /parallax -->
<!-- /PAGE TOP -->

<!-- Top Nav -->
<div class="navbar-collapse nav-main-collapse collapse">
	<nav class="nav-main">
		<ul id="topMain" class="nav nav-pills nav-main">
			{% if user.is_authenticated %}
				<li><a href="{% url 'libros:nuevo_libro' 'perfil' user.username %}"><i class="fa fa-book"></i> Compartir un Libro</a></li>
				<li><a href="{% url 'grupos:crear_grupo' %}"><i class="fa fa-group"></i> Crear un Grupo</a></li>
			{% else %}
				<li><a href="{% url 'libros:main' %}"><i class="fa fa-lock"></i> Compartir un Libro</a></li>
				<li><a href="{% url 'libros:main' %}"><i class="fa fa-lock"></i> Crear un Grupo</a></li>
			{% endif %}
			<li><a href=""><i class="fa fa-map-marker"></i> Buscar otras Ciudades</a></li>
		</ul>
	</nav>
</div>
<!-- /Top Nav -->

<div id="mapa_ciudad" data-url-cincobcompartida="{% url 'libros:cinco_bcompartida' %}" class=""><!-- map container --></div>

<div class = "col-md-8">
	<!--
	<a href="{% url 'libros:buscar_ciudad' %}" class="pull-right">Buscar libros en otra ciudad <i class="fa fa-external-link-square"></i></a>
	-->
	<hr class =" half-margins invisible">

	{% if filtro == "autor" %}
	
	<div class="widget">
		<form method="get" action="{% url 'libros:buscar' 'quito' 'autor' %} " class="input-group">
			<input type="text" class="form-control" name="q" placeholder="Buscar Autor" />
			<span class="input-group-btn">
				<button type="submit" class="btn btn-primary"><i class="fa fa-search"></i></button>
			</span>
		</form>
	</div>
	<br>
	<div class="btn-group">
	  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">Ordenar por Autor <i class ="fa fa-pencil"></i></button>
	  <ul class="dropdown-menu" role="menu">
		<li><a href="{% url 'libros:libros_ciudad' 'quito' '18' 'titulo' %}">Ordenar por Título <i class="fa fa-book"></i> </a></li>
	  </ul>
	</div><!-- /btn-group -->

	{% else %}
	
	<div class="widget">
		<form method="get" action="{% url 'libros:buscar' 'quito' 'titulo' %}" class="input-group">
			<input type="text" class="form-control" name="q" placeholder="Buscar Título" />
			<span class="input-group-btn">
				<button type="submit" class="btn btn-primary"><i class="fa fa-search"></i></button>
			</span>
		</form>
	</div>
	<br>
	<div class="btn-group">
	  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">Ordenar por Título <i class ="fa fa-book"></i></button>
	  <ul class="dropdown-menu" role="menu">
		<li><a href="{% url 'libros:libros_ciudad' 'quito' '18' 'autor' %}">Ordenar por Autor <i class="fa fa-pencil"></i> </a></li>
	  </ul>
	</div><!-- /btn-group -->
	
	{% endif %}

	<div class="divider"><!-- divider -->
		<i class="fa fa-chevron-down"></i>
	</div>
	
	<br>
	{% for l in libros_disponibles %}	
		<div class="alert callout alert-default">
			<div class="row">
				<div class="col-md-9 col-sm-9"><!-- left text -->
					<h4><strong>{{l.libro.titulo}}</strong> {{l.libro.autor}} </h4>

                    {% if l.biblioteca_compartida %}
                        <a href="{% url 'libros:biblioteca_compartida' l.biblioteca_compartida.slug %} ">{{ l.biblioteca_compartida.nombre }}</a>
                    {% else %}
                        <a href="{% url 'perfiles:perfil_usuario' l.perfil.usuario.username %}">
                            <i class = "fa fa-user"></i>{{l.perfil.usuario.username}}
                        </a>
                    {% endif %}
				</div>

                {% if l.biblioteca_compartida %}

                {% else %}
                    {% if l.perfil != perfil_usuario and user.is_authenticated %}
                    <!-- Si el usuario es dueño de su libro no puede pedirlo prestado -->
                    <div class="col-md-3 col-sm-3 text-right">
                        <a href="{% url 'libros:pedir_libro' l.id %}" rel="nofollow" target="_blank" class="btn btn-default btn-lg">Pedir Libro</a>
                    </div>
                    {% endif %}
                {% endif %}
			</div>
		</div>
	{% endfor %}

	<ul class="pagination">
	 	{% if paginator.has_previous %}
		<li><a href="?page={{ paginator.previous_page_number }}">&laquo;</a></li>
		{% else %}
		<li class="disabled"><a>&laquo;</a></li>
        {% endif %}
       
		{% for numero_pagina in paginator.page_range %}
			<li class="{% if numero_pagina == libros_disponibles.number %}active{% endif %}"><a href="?page={{numero_pagina}}">{{numero_pagina}}</a></li>
		{% endfor %}
		
		{% if paginator.has_next %}
            <a href="?page={{ paginator.next_page_number }}">&raquo;</a>
        {% else %}
        <li class="disabled"><a class="disabled">&raquo;</a></li>
        {% endif %}
	</ul>
</div>

<div class = "col-md-4">
	<hr class="half-margins invisible" /><!-- divider 30px -->

	{% if grupos_abiertos %}
		<h4> Grupos abiertos en Quito </h4>
		{% for grupo in grupos_abiertos %}
			<a href="{% url 'grupos:main_grupo_actividad' grupo.id %}">{{grupo.nombre}}</a>
			<br>
		{% endfor %}
	{% endif %}

	<hr class = "half-margins invisible"></hr>

	{% if grupos_usuario %}
		<h4> Tus Grupos </h4>
		{% for u_grupo in grupos_usuario %}
			<a href="{% url 'grupos:main_grupo_actividad' u_grupo.grupo.id %}"> {{ u_grupo.grupo.nombre }} </a>
			<br>
		{% endfor %}
	{% endif %}
	
	
	<hr class="half-margins invisible" /><!-- divider 30px -->
	
	<h4> Bibliotecas Compartidas</h4>

	<div class="tabs nomargin">
		<div class="tab-content">	
			<div id="tab_1" class="tab-pane active">

				{% for biblioteca in bibliotecas_compartidas %}
				<div class="row tab-post">
					<div class="col-md-3 col-sm-3 col-xs-3">
						<a href="{% url 'libros:biblioteca_compartida' biblioteca.slug %}">
							<img src="{{biblioteca.imagen}}" width="50" alt="" />
						</a>
					</div>
					<div class="col-md-9 col-sm-9 col-xs-9">
						<a href="{% url 'libros:biblioteca_compartida' biblioteca.slug %}" class="tab-post-link">{{biblioteca.nombre}}</a>
						<small>{{biblioteca.direccion}}</small>
					</div>
				</div>
				{% endfor %}
			</div>	
		</div>
	</div>

	<a href="{% url 'perfiles:contactanos' 'registrar_biblioteca' %}" class="pull-right"> 
		<small>Registrar una Biblioteca Compartida en {{ciudad.name}}</small>
	</a>
	
	<div class ="divider"></div>

	<p class ="well">
	Actualmente hay <strong>{{num_libros_disponibles}}</strong> libros compartidos en {{ciudad.name}}.

	</p>

	<p class ="well alert-info">
        <i class ="fa fa-info-circle"></i>
        Los libros compartidos son libros <strong>físicos</strong> (no digitales) que los miembros de la comunidad han aceptado cambiar o prestar. <br>
	</p>

	<!-- facebook -->
	<div class="fb-page" data-href="https://www.facebook.com/letras.club" data-hide-cover="false" data-show-facepile="true" data-show-posts="false"><div class="fb-xfbml-parse-ignore"><blockquote cite="https://www.facebook.com/facebook"><a href="https://www.facebook.com/facebook">Facebook</a></blockquote></div></div>
	
</div>
{% endblock content %}


{% block extra_javascript %}
    <script src="http://maps.googleapis.com/maps/api/js?v=3"></script>
    <script>
        var gmaps_bcompartidas = JSON.parse('{{ gmap_bcompartidas|safe }}');

        markers = [];
        $.each(gmaps_bcompartidas, function(index, value){
            marker = [value[0], value[1], value[2], value[3]];
            markers.push(marker);
        });

        var map_center = new google.maps.LatLng(-0.179041, -78.499211);

        var map_options = {
            zoom: 13,
            center: map_center,
            disableDefaultUI: false,
            navigationControl: false,
            mapTypeControl: false,
            scrollwheel: false,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };

        function initMap() {
            var map = new google.maps.Map(document.getElementById('mapa_ciudad'), map_options);
            marker_objects = [];

            function AutoCenter() {
                var bounds = new google.maps.LatLngBounds();
                $.each(marker_objects, function (index, marker) {
                    bounds.extend(marker.position)
                });
                map.fitBounds(bounds);
            }

            function sumarMensaje(marker, biblioteca_slug) {
                var infowindow = new google.maps.InfoWindow();
                var contenido_infowindow = "Biblioteca Compartida";

                marker.addListener('click', function () {
                    var url_target = $("#mapa_ciudad").data("url-cincobcompartida");

                    $.ajax({
                        method: "GET",
                        url: url_target,
                        data: {'bcompartida_slug': biblioteca_slug},
                        success: function(response){
                            var respuesta = JSON.parse(response);
                            console.log(respuesta);
                            contenido_infowindow = '<div> <ul>';
                            $.each(respuesta.libros, function(key, value){
                                contenido_infowindow += '<li>' + value + '</li>';
                            });
                            contenido_infowindow += '</ul>';
                            var datos_bcompartida = respuesta.datos_bcompartida;
                            contenido_infowindow += '<a class = "pull-right" href='+datos_bcompartida[0]+'>'+datos_bcompartida[1]+'</a>';

                            infowindow.setContent(contenido_infowindow);
                            infowindow.open(map, marker);
                        },
                        error: function(response){
                            console.log(response);
                        }
                    });
                });
            }

            for (i = 0; i < markers.length; i++) {
                console.log(markers[i]);
                marker = new google.maps.Marker({
                    position: new google.maps.LatLng(markers[i][1], markers[i][2]),
                    map: map,
                    title: markers[i][0]
                });

                sumarMensaje(marker, markers[i][3]);
                marker_objects.push(marker);
            }

            google.maps.event.addListenerOnce(map, 'bounds_changed', function(event) {
              if (this.getZoom() > 14) {
                this.setZoom(14);
              }
            });

            AutoCenter();
            }

        initMap();

    </script>
{% endblock extra_javascript %}
